= Smarti Comprehensive Developer's Guide
RÃ¼diger Kurz  <kurz@vnc-online.de>
v1.0, 2017-08-26
:toc: right

:imagesdir: ./images

== Introduction

*Smarti* is a https://java.com/[Java]-Application based on the https://spring.io/[Spring Framework].
The application uses https://www.mongodb.com/[MongoDB] as database and http://lucene.apache.org/solr/[Apache Solr] as saerch engine.
Installation packages are provided for https://www.debian.org/[Debian]- and https://www.redhat.com/[RedHat]-based systems.
Alternatively the application can be started by directly launching the executable jar:

```bash
$ java -jar smarti-${smarti-version}-exec.jar
```

This document is written for developers, operators and administrators who like to

* *debug, change and contribute* Smarti code,
* *run* Smarti on a local machine,
* *deploy* Smarti on a server and
* *help Smarti* get a better application.

All interested can convince themselves of the documentation quality. +
And if you caught fire, maybe you will become a Smarti developer very soon ;-)

TIP: @all if you find typos, missing sections or if you have any other kind of helpful advice to improve this documentation or *Smarti* in general, please let us know.
Share your thoughts and open an issue right https://github.com/redlink-gmbh/smarti/issues[here].
The *Smarti* community will help you along, as fast as possible.


== Build and Run

This section explains how to checkout and build the Smarti application from its sources.
By following these steps you will learn how to build, run and debug Smarti.
Transfer these instructions on your local machine in order to start setting up your Software Development Environment (SDE).

In order to build & run Smarti the <<system-requirements.adoc#,System requirements>> have to be fulfilled.
How to achieve that heavily depends on your target environment.
When creating this documentation all commands have been executed and tested with http://releases.ubuntu.com/16.04/[Ubuntu 16.04. LTS] server running on https://aws.amazon.com/ec2/instance-types/[Amazon EC2 instance] (t2.large).
Therefore and to keep it simple we decided to use Debian's package manager `apt-get` for documentation purpose.

WARNING: *Be careful using `copy & paste`.* +
The aim of this manual is to explain and not to provide scripts.

=== Prepare

. Install Java
+
```bash
 $ sudo apt-get install openjdk-8-jdk
```

 . Install MongoDB (optional)
+
```bash
  $ sudo apt-get install mongodb-server
```

. Install build components
+
```bash
 $ sudo apt-get install git maven sass ruby-compass
```

[TIP]
====
*For other operating systems*
check the installation manuals for the target platform:

* https://git-scm.com/book/en/v2/Getting-Started-Installing-Git[Git]
* https://maven.apache.org/install.html[Maven]
* https://www.ruby-lang.org/en/documentation/installation/[Ruby]
* and on top of ruby using the ruby package manager
```
sudo gem install sass compass
```

====

=== Checkout

. Create a source directory `${smarti-source}`
+
```bash
 $ mkdir ${smarti-source}
```

. Checkout https://github.com/redlink-gmbh/smarti/tree/develop[*Smarti* source code] from https://github.com/[GitHub]
+
```bash
 $ git clone https://github.com/redlink-gmbh/smarti.git ${smarti-source}
```

=== Build

. Change into the source directory
+
```bash
 $ cd ${smarti-source}
```

. Execute maven build
+
```bash
 $ mvn clean install [ -Pdeb | -Prpm ]
```
+
NOTE: Installation packages can be built for https://www.debian.org/[Debian]- and https://www.redhat.com/[RedHat]-based systems.
+
NOTE: The build artifacts are finally placed in the `${smarti-source}/dist/target` directory.

=== Run

. Create a working directory
+
```bash
  $ mkdir ${smarti-home} && cd ${smarti-home}
```
+
NOTE: *Working directory* - If you launch smarti the first time the `application.properties` file is created inside the directory where `java -jar` is executed.
When ever this documentation refers the `${smarti-home}`, the directory where the `application.properties` is located, is being meant.
Since Smarti is a Spring boot application you can externalize the configuration as explained in the https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html[Spring docs].

. Copy the executable jar into `${smarti-home}`
+
```bash
  $ mv ${smarti-source}/dist/target/smarti-${smarti-version}-exec.jar .
```

. Launch smarti
+
```bash
  $ java -jar smarti-${smarti-version}-exec.jar
```
+
NOTE: *Stanford NLP* - If you want to use Stanford NLP analysis, ensure that the required libraries are included in the classpath.
For more information and how to achieve this read section <<Enable Stanford NLP>>.
+
NOTE: *Common challenges* - If this the first time you're running *Smarti*, you may have been stepped into a pitfall and it does not work.
We have picked up some common challenges that might be helpful.
See sections <<trouble-shooting.adoc#, Troubleshooting>> in any case of problems.

=== Debug

. Launch smarti in debug mode
+
To launch *Smarti* in debug mode create a shell script appending preferred options to the `java`-command like:
+
.start-smarti.sh
```bash
#!/bin/bash
java -Xmx4g -jar -Xdebug application/target/smarti-${smarti-version}-exec.jar\
    -Xrunjdwp:transport=dt_socket,address=${smarti-debug-port},server=y,suspend=n\
    -Dspring.profiles.active=local\
    --solrlib.home=${solr-home}
```

. Configure your IDE
+
Create a debug configuration for the `Remote Java Application` and set the specified `${smarti-debug-port}`.
+
image::debug-configuration.png[]

'''

NOTE: Now you are ready to start developing the next amazing feature for *Smarti*.

=== Release

For a release, a release branch (based on develop) is created which represents the release candidate.
If the candidate fulfills the requirements, the issues of the release are documented in the changelogs.
Then the version number is set to the release number, the branch is merged into master and the master is tagged with the release number.
Additionally, the version number of the develop branch is set to the new snapshot version.


== Additional components

Due to licensing-issues (e.g. https://www.gnu.org/licenses/gpl-3.0.html[GPL]), some optional dependencies are not part if the distribution pacakges.
To enable these additional modules, you need to put the missing libraries into the `ext`-folder in the working directory.

NOTE: When installed with the provided `deb` or `rpm` package, this folder is located at `/var/lib/smarti/ext` and contains a simple readme.

NOTE: When running Smarti by directly executing the jar file, you need to create the `ext` directory relative to the location where the `java` command is executed `${smarti-home}/ext`.

.plugin-info.txt
:includedir: _includes
:sourcedir: ../../dist/src/main/resources
[source,java]
----
include::{sourcedir}/plugin-info.txt[]
----

=== Enable Stanford NLP

To enable analysis based on https://nlp.stanford.edu/[Stanford NLP], put the following libraries into the `ext`-folder.

* https://repo1.maven.org/maven2/edu/stanford/nlp/stanford-corenlp/3.6.0/stanford-corenlp-3.6.0.jar[stanford-corenlp-3.6.0.jar]
* https://repo1.maven.org/maven2/edu/stanford/nlp/stanford-corenlp/3.6.0/stanford-corenlp-3.6.0-models-german.jar[stanford-corenlp-3.6.0-models-german.jar]

```bash
$ cd /var/lib/smarti/ext
$ wget https://repo1.maven.org/maven2/edu/stanford/nlp/stanford-corenlp/3.6.0/stanford-corenlp-3.6.0.jar
$ wget https://repo1.maven.org/maven2/edu/stanford/nlp/stanford-corenlp/3.6.0/stanford-corenlp-3.6.0-models-german.jar
```


== Application documentation

=== Endpoints

==== Admin UI

  http://${smarti-host}:${smarti-port}/

==== REST API (Swagger)

  http://${smarti-host}:${smarti-port}/v2/api-docs

==== Rocket.Chat integration JS

  http://${smarti-host}:${smarti-port}/plugin/v1/rocket.chat.js


=== Client Configurations

Find detailed description on how to add and configure clients in the <<clientConfig.adoc#,Client Configurations>> section.
